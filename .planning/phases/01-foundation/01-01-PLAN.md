---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - worker/package.json
  - worker/src/index.ts
  - worker/src/db/schema.ts
  - worker/src/db/client.ts
  - worker/wrangler.toml
  - worker/drizzle.config.ts
  - worker/.dev.vars.example
  - frontend/package.json
  - frontend/src/main.tsx
  - frontend/src/App.tsx
  - frontend/vite.config.ts
  - frontend/tsconfig.json
  - frontend/index.html
  - migrations/0001_initial_schema.sql
  - .gitignore
  - tsconfig.base.json
autonomous: true
user_setup:
  - service: cloudflare
    why: "D1 database and Workers deployment"
    env_vars:
      - name: CLOUDFLARE_ACCOUNT_ID
        source: "Cloudflare Dashboard -> Workers & Pages -> Overview (right sidebar)"
      - name: CLOUDFLARE_API_TOKEN
        source: "Cloudflare Dashboard -> My Profile -> API Tokens -> Create Token (use 'Edit Cloudflare Workers' template)"
    dashboard_config:
      - task: "Create D1 database named 'lecpa-pnl'"
        location: "Cloudflare Dashboard -> Workers & Pages -> D1 -> Create database"

must_haves:
  truths:
    - "Monorepo structure exists with worker/ and frontend/ directories"
    - "Hono server starts and responds to health check"
    - "React app loads in browser"
    - "D1 database schema includes users, magic_links, and projects tables"
    - "Drizzle can connect to D1 and run queries"
  artifacts:
    - path: "worker/src/index.ts"
      provides: "Hono app entry point with health endpoint"
      exports: ["default"]
    - path: "worker/src/db/schema.ts"
      provides: "Drizzle schema for users, magic_links, projects"
      exports: ["users", "magicLinks", "projects"]
    - path: "frontend/src/App.tsx"
      provides: "React app root component"
      min_lines: 15
    - path: "migrations/0001_initial_schema.sql"
      provides: "Initial database migration"
      contains: "CREATE TABLE"
  key_links:
    - from: "worker/src/index.ts"
      to: "worker/src/db/client.ts"
      via: "drizzle client import"
      pattern: "import.*drizzle|from.*db/client"
    - from: "frontend/vite.config.ts"
      to: "worker dev server"
      via: "proxy configuration"
      pattern: "proxy.*localhost:8787"
---

<objective>
Set up the monorepo project structure with Hono backend (Cloudflare Workers), React frontend (Vite), and D1 database schema.

Purpose: Establish the foundational infrastructure that all subsequent features will build upon. This creates the development environment, database schema, and basic project scaffolding.

Output: Working monorepo with backend health endpoint, frontend shell, and database tables for users, magic_links, and projects.
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

Key patterns from research:
- Hono route organization with type-safe bindings
- Drizzle schema with INTEGER timestamps and indexes
- Vite proxy for local development
- D1 migrations via wrangler
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize monorepo structure and root configuration</name>
  <files>
    package.json
    tsconfig.base.json
    .gitignore
  </files>
  <action>
Create root package.json as workspace root (NOT a monorepo package manager - just scripts):
```json
{
  "name": "lecpa-pnl",
  "private": true,
  "scripts": {
    "dev": "concurrently \"npm run dev:worker\" \"npm run dev:frontend\"",
    "dev:worker": "cd worker && npm run dev",
    "dev:frontend": "cd frontend && npm run dev",
    "build": "cd frontend && npm run build",
    "db:generate": "cd worker && npx drizzle-kit generate",
    "db:migrate:local": "cd worker && wrangler d1 migrations apply lecpa-pnl --local",
    "db:migrate:remote": "cd worker && wrangler d1 migrations apply lecpa-pnl --remote"
  },
  "devDependencies": {
    "concurrently": "^8.2.2"
  }
}
```

Create tsconfig.base.json with shared TypeScript settings:
- strict: true
- target: ES2022
- moduleResolution: bundler

Update .gitignore to include:
- node_modules
- dist
- .wrangler
- .dev.vars
- *.local
- .DS_Store
  </action>
  <verify>
    - `cat package.json` shows workspace scripts
    - `cat tsconfig.base.json` shows strict mode enabled
    - `cat .gitignore` includes .dev.vars
  </verify>
  <done>Root workspace configuration complete with npm scripts for development</done>
</task>

<task type="auto">
  <name>Task 2: Set up Hono backend with D1 schema</name>
  <files>
    worker/package.json
    worker/src/index.ts
    worker/src/db/schema.ts
    worker/src/db/client.ts
    worker/wrangler.toml
    worker/drizzle.config.ts
    worker/.dev.vars.example
    worker/tsconfig.json
  </files>
  <action>
Create worker/package.json with dependencies:
- hono (web framework)
- drizzle-orm (ORM)
- @tsndr/cloudflare-worker-jwt (JWT)
- resend (email)
- zod (validation)
- Dev: drizzle-kit, wrangler, typescript, @cloudflare/workers-types

Create worker/src/db/schema.ts with Drizzle schema:
```typescript
import { sqliteTable, integer, text, index } from 'drizzle-orm/sqlite-core';

export const users = sqliteTable('users', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  email: text('email').notNull().unique(),
  name: text('name'),
  createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
  lastLogin: integer('last_login', { mode: 'timestamp' })
}, (table) => [
  index('users_email_idx').on(table.email)
]);

export const magicLinks = sqliteTable('magic_links', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  userId: integer('user_id').notNull().references(() => users.id),
  token: text('token').notNull().unique(),
  expiresAt: integer('expires_at', { mode: 'timestamp' }).notNull(),
  usedAt: integer('used_at', { mode: 'timestamp' })
}, (table) => [
  index('magic_links_token_idx').on(table.token),
  index('magic_links_expires_idx').on(table.expiresAt)
]);

export const projects = sqliteTable('projects', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  userId: integer('user_id').notNull().references(() => users.id),
  clientName: text('client_name').notNull(),
  clientEmail: text('client_email').notNull(),
  industry: text('industry').notNull(),
  periodStart: integer('period_start', { mode: 'timestamp' }).notNull(),
  periodEnd: integer('period_end', { mode: 'timestamp' }).notNull(),
  status: text('status').notNull().default('active'),
  deletedAt: integer('deleted_at', { mode: 'timestamp' }),
  createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
  updatedAt: integer('updated_at', { mode: 'timestamp' }).notNull()
}, (table) => [
  index('projects_user_id_idx').on(table.userId),
  index('projects_status_idx').on(table.status)
]);
```

Create worker/src/db/client.ts:
```typescript
import { drizzle } from 'drizzle-orm/d1';
import * as schema from './schema';

export function createDb(d1: D1Database) {
  return drizzle(d1, { schema });
}
export type Database = ReturnType<typeof createDb>;
```

Create worker/src/index.ts with Hono app:
- Define Bindings type (DB: D1Database, JWT_SECRET: string, RESEND_API_KEY: string, APP_URL: string, RATE_LIMITER: RateLimiter)
- Create Hono app with typed bindings
- Add CORS middleware (origin from APP_URL env var)
- Add GET /api/health endpoint returning { status: 'ok', timestamp }
- Export default app

Create worker/wrangler.toml:
```toml
name = "lecpa-pnl-worker"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "lecpa-pnl"
database_id = "YOUR_DATABASE_ID"  # User replaces after creating D1
migrations_dir = "../migrations"

[[unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1"
simple = { limit = 10, period = 60 }

[vars]
APP_URL = "http://localhost:5173"
```

Create worker/.dev.vars.example:
```
JWT_SECRET=your-jwt-secret-at-least-32-chars-long
RESEND_API_KEY=re_xxxxxxxx
```

Create worker/drizzle.config.ts for migrations.

Create worker/tsconfig.json extending base config.
  </action>
  <verify>
    - `cd worker && npm install` completes without errors
    - `cd worker && npx tsc --noEmit` shows no type errors
    - `cat worker/src/db/schema.ts` shows all three tables with indexes
  </verify>
  <done>Hono backend scaffolded with typed D1 schema for users, magic_links, and projects</done>
</task>

<task type="auto">
  <name>Task 3: Set up React frontend and generate migration</name>
  <files>
    frontend/package.json
    frontend/src/main.tsx
    frontend/src/App.tsx
    frontend/src/lib/api.ts
    frontend/vite.config.ts
    frontend/tsconfig.json
    frontend/index.html
    migrations/0001_initial_schema.sql
  </files>
  <action>
Create frontend/package.json with dependencies:
- react, react-dom
- @tanstack/react-query
- react-hook-form, @hookform/resolvers
- zod
- react-router-dom
- Dev: vite, @vitejs/plugin-react, typescript, @types/react, @types/react-dom

Create frontend/index.html with root div and title "LeCPA P&L Generator".

Create frontend/src/main.tsx:
- QueryClient with staleTime: 5 minutes
- QueryClientProvider wrapper
- BrowserRouter wrapper
- Render App component

Create frontend/src/App.tsx:
- Simple placeholder with "LeCPA P&L Generator" heading
- Link to /login (placeholder for now)

Create frontend/src/lib/api.ts:
```typescript
const API_BASE = '/api';

export async function apiFetch<T>(
  path: string,
  options: RequestInit = {}
): Promise<T> {
  const res = await fetch(`${API_BASE}${path}`, {
    ...options,
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json',
      ...options.headers,
    },
  });
  if (!res.ok) {
    const error = await res.json().catch(() => ({ error: 'Request failed' }));
    throw new Error(error.error || 'Request failed');
  }
  return res.json();
}
```

Create frontend/vite.config.ts with:
- react plugin
- @ alias to ./src
- proxy /api to http://localhost:8787

Create frontend/tsconfig.json with paths alias.

Generate database migration:
Run `cd worker && npx drizzle-kit generate` to create migrations/0001_initial_schema.sql
If drizzle-kit doesn't auto-generate, manually create the SQL with CREATE TABLE statements matching the schema.
  </action>
  <verify>
    - `cd frontend && npm install` completes without errors
    - `cd frontend && npx tsc --noEmit` shows no type errors
    - `ls migrations/` shows 0001_initial_schema.sql exists
    - `cat migrations/0001_initial_schema.sql` shows CREATE TABLE statements
  </verify>
  <done>React frontend scaffolded with TanStack Query, routing, and D1 migration generated</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Root level verification:**
   ```bash
   npm install
   ```
   Should install concurrently in root.

2. **Backend verification:**
   ```bash
   cd worker && npm install && npm run dev
   ```
   Worker should start on port 8787. Health check:
   ```bash
   curl http://localhost:8787/api/health
   ```
   Should return `{"status":"ok","timestamp":"..."}`.

3. **Frontend verification:**
   ```bash
   cd frontend && npm install && npm run dev
   ```
   Should start on port 5173. Visit http://localhost:5173 to see app shell.

4. **Database schema verification:**
   ```bash
   cat migrations/0001_initial_schema.sql
   ```
   Should contain CREATE TABLE for users, magic_links, projects with proper columns and indexes.
</verification>

<success_criteria>
1. `npm run dev` from root starts both worker (8787) and frontend (5173)
2. GET /api/health returns 200 with status:ok
3. Frontend loads and displays "LeCPA P&L Generator"
4. Migration file exists with all three tables defined
5. TypeScript compiles without errors in both worker and frontend
6. All dependencies installed without version conflicts
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
