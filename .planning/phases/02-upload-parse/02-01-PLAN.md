---
phase: 02-upload-parse
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - worker/src/db/schema.ts
  - migrations/0002_uploads_transactions.sql
autonomous: true

must_haves:
  truths:
    - "Uploads table stores upload metadata (project, bank type, status)"
    - "Transactions table stores parsed transaction fields (date, description, amount, memo)"
    - "Upload deletion cascades to remove associated transactions"
  artifacts:
    - path: "worker/src/db/schema.ts"
      provides: "Uploads and transactions table definitions with types"
      contains: "uploads"
    - path: "migrations/0002_uploads_transactions.sql"
      provides: "DDL for uploads and transactions tables"
      contains: "CREATE TABLE"
  key_links:
    - from: "transactions table"
      to: "uploads table"
      via: "uploadId foreign key"
      pattern: "references.*uploads"
    - from: "uploads table"
      to: "projects table"
      via: "projectId foreign key"
      pattern: "references.*projects"
---

<objective>
Add database schema for uploads and transactions to support CSV import functionality.

Purpose: Phase 2 requires storing upload metadata (which bank, how many transactions, when) and parsed transaction data (date, description, amount, memo). This plan extends the existing Drizzle schema and generates the migration.

Output: Extended schema.ts with uploads and transactions tables, migration SQL file ready for D1.
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-upload-parse/02-RESEARCH.md

Relevant existing code:
@worker/src/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add uploads and transactions tables to schema</name>
  <files>worker/src/db/schema.ts</files>
  <action>
Extend the existing Drizzle schema with two new tables:

**uploads table:**
- id: integer primary key autoincrement
- projectId: integer foreign key to projects.id (NOT NULL)
- bankType: text NOT NULL (enum: 'chase', 'bankofamerica', 'wellsfargo', 'capitalone', 'amex')
- accountType: text NOT NULL (enum: 'checking', 'credit')
- filename: text NOT NULL (original filename for reference)
- transactionCount: integer NOT NULL (how many transactions imported)
- status: text NOT NULL default 'active' (active, deleted)
- deletedAt: integer timestamp nullable (for soft delete)
- createdAt: integer timestamp NOT NULL

Add indexes:
- uploads_project_id_idx on projectId
- uploads_status_idx on status

**transactions table:**
- id: integer primary key autoincrement
- projectId: integer foreign key to projects.id (NOT NULL)
- uploadId: integer foreign key to uploads.id (NOT NULL)
- date: integer timestamp NOT NULL (transaction date)
- description: text NOT NULL (merchant/payee description)
- amount: integer NOT NULL (cents, negative = expense, positive = income)
- memo: text nullable (optional memo/note field)
- bucket: text NOT NULL default 'needs_review' (business, personal, needs_review)
- categoryId: integer nullable (will be used in Phase 3)
- confidence: integer nullable (0-100, AI confidence score for Phase 3)
- isTransfer: integer NOT NULL default 0 (boolean, for Phase 4 transfer detection)
- isDuplicate: integer NOT NULL default 0 (boolean, for Phase 4 duplicate detection)
- createdAt: integer timestamp NOT NULL
- updatedAt: integer timestamp NOT NULL

Add indexes:
- transactions_project_id_idx on projectId
- transactions_upload_id_idx on uploadId
- transactions_date_idx on date
- transactions_bucket_idx on bucket

Export types: Upload, NewUpload, Transaction, NewTransaction

IMPORTANT: Use the object syntax for extraConfig (not array) as established in Phase 1.
  </action>
  <verify>Run `cd /Users/tungmbp1423/Projects/lecpa-pnl-c/worker && npx tsc --noEmit` - should compile without errors</verify>
  <done>Schema file contains uploads and transactions tables with proper foreign keys, indexes, and type exports</done>
</task>

<task type="auto">
  <name>Task 2: Generate database migration</name>
  <files>migrations/0002_uploads_transactions.sql</files>
  <action>
Generate the Drizzle migration for the new tables:

1. Run drizzle-kit generate to create migration
2. Rename the generated migration file to `0002_uploads_transactions.sql` for clarity
3. Verify the migration contains:
   - CREATE TABLE uploads with all columns and indexes
   - CREATE TABLE transactions with all columns and indexes
   - Foreign key constraints to projects and uploads tables

Run from worker directory: `npx drizzle-kit generate`

After generation, verify the SQL is correct:
- Uploads table has projectId FK
- Transactions table has projectId and uploadId FKs
- All indexes are created
- Default values are set correctly
  </action>
  <verify>
1. Migration file exists: `ls /Users/tungmbp1423/Projects/lecpa-pnl-c/migrations/0002_*.sql`
2. SQL contains CREATE TABLE uploads
3. SQL contains CREATE TABLE transactions
  </verify>
  <done>Migration file 0002_uploads_transactions.sql exists and contains correct DDL for both tables with foreign keys and indexes</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cd /Users/tungmbp1423/Projects/lecpa-pnl-c/worker && npx tsc --noEmit` - TypeScript compiles
2. `grep -l "uploads" worker/src/db/schema.ts` - uploads table defined
3. `grep -l "transactions" worker/src/db/schema.ts` - transactions table defined
4. `ls migrations/0002_*.sql` - migration exists
</verification>

<success_criteria>
- [ ] worker/src/db/schema.ts exports uploads table with all required columns
- [ ] worker/src/db/schema.ts exports transactions table with all required columns
- [ ] Foreign keys link transactions -> uploads -> projects
- [ ] Type exports: Upload, NewUpload, Transaction, NewTransaction
- [ ] Migration file generated with correct DDL
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-upload-parse/02-01-SUMMARY.md`
</output>
